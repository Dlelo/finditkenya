extends ../layout-coupon

block content
  div.container-fluid
  #home.parallax-content-list.baner-content-listing-biz
    .container-fluid.container-margin-top.container-fluidpadding
     .row.couponbg-color

       div.col-md-9(style="padding-right:0; padding-left:15px;")
          row.my-row
            
              div#carouselExampleFade.carousel.slide.carousel-fade(data-ride="carousel")
                ol.carousel-indicators
                  li.active(data-target="#carouselExampleIndicators" data-slide-to="0")
                  li(data-target="#carouselExampleIndicators" data-slide-to="1")
                  li(data-target="#carouselExampleIndicators" data-slide-to="2")

                
                div.carousel-inner
                  each coupon, i in coupons
                    if (i==0)
                      div.carousel-item.active
                          img.d-block.w-100.coupons-img.carousel-img(src="/uploads/" + coupon.photo, alt=coupon.bizid.name)
                          a(href="/biz/"+coupon.bizid.slug)
                            div.carousel-caption.d-none.d-md-block
                              div(style="color:#fff")
                                h3.text-left
                                  =coupon.bizid.name
                                h4.text-left
                                  =coupon.description
                                span.text-left.badge.badge-light.findit-red
                                  h6.findit-red
                                    =coupon.tagline
                  each coupon, i in coupons
                    if (i>0 && i<3)
                      div.carousel-item
                          img.d-block.w-100.coupons-img.carousel-img(src="/uploads/" + coupon.photo, alt=coupon.bizid.name)
                          a(href="/biz/"+coupon.bizid.slug)
                            div.carousel-caption.d-none.d-md-block
                              div(style="color:#fff")
                                h3.text-left
                                  =coupon.bizid.name
                                h4.text-left
                                  =coupon.description
                                span.text-left.badge.badge-light.findit-red
                                  h6.findit-red
                                    =coupon.tagline
          
                    
    
                a.carousel-control-prev(href="#carouselExampleFade" role="button" data-slide="prev")
                  span.carousel-control-prev-icon(aria-hidden="true")

                a.carousel-control-next(href="#carouselExampleFade" role="button" data-slide="next")
                  span.carousel-control-next-icon(aria-hidden="true")
      
        
       div.col-md-3
         row
            h5
              .coupon-title
                | Popular Coupons
            each popular, i in populars
              if i<2  
                row.deal-main.deal-home.deal-coup
                  .col-md-12
                    small
                      h6
                        =popular.name
                    each bz in popular.biz
                      img.coup-img(src="/uploads/thumbs/coupons/"+ popular.photo, alt=bz.name + '  on FindIt Kenya')
                    p
                       small
                          p
                            =popular.description
                          p
                          each bz in popular.biz
                            | @  
                            =bz.name
                          p
                          strong.findit-red
                            =popular.tagline 
                            
                             
                         
                          
                  
                

         //row
            h5
            .coupon-title
              |  Selected Coupons
            div
              .mycoupons#coupons-sticky
  div.container-fluid
    nav.navbar.navbar-expand-lg.navbar-light.bg-light#navbarCoup
      ul.navbar-nav.mr-auto
        li.nav-item.dropdown.open.text-left
            button.btn.btn-cat.btn-light.form-control.dropdown-toggle(type='button', data-toggle='dropdown')
              h5.coupon-title
                | Search Coupon by Category
                
              span.caret
            div#items.dropdown-menu.open.sub-catbag.drop-down-sub.dropdown-menu-coupon.dropdown-category
              
              if groups 
                button(class="btn btn-light category-button" data-filter = "all")
                  strong
                    |  All Categories (
                  span
                    =groups.length + ')'
                each group in groups
                  div.text-left.sub-list
                    //a(href="#"+group._id)
                    button(class="btn btn-light category-button" data-filter = ''+group._id+'')
                      strong  
                        =group._id + " (" + group.count + ")" 
        li.nav-item
          row
            .col-md-6.col-sm-12.col-xs-12
              button#myBtn.btn.btn-danger.btn-cat-coupon.selected-coupon-left
                h4.agile-title.text-center
                  =  "  Selected Coupons  "
                  span.badge.badge-light  
                    span#couponscount(style="color:#c00000") 
                        =mycoupons.length
                  span.fas.fa-envelope                    
        
            .col-md-6.col-sm-12.col-xs-12
              div#myModal.modal
                div.modal-content
                  span.close.text-right
                    |&times;
                  div 
                  .coupon-title
                    h3.text-center
                      |  Selected Coupons
                  div
                    .mycoupons#coupons-sticky
                      each mycoupon in mycoupons
                        .coupon.coupon-modal
                          strong 
                            =mycoupon.name
                          i.fa.fa-close.fa-fw.text-right.del-coupon(rel=mycoupon._id, aria-hidden='true',id=user.id)
                  div
                     strong
                      a(href="/admin/email/coupons" class="text-center")
                        h4
                          i(class="fa fa-envelope fa-fw" aria-hidden="true")
                          | Mail All
        li.nav-item
          div#searchCoup
            form.form-class(method='get', action='/search')
              div.input-group
                input.search2.form-control-lg(type="text" placeholder="Businesses, Doctors, Lawyers, Hotels" ,style="width:100% !important" ,name='search', autofocus)              
              
    .row.deal-main
      .col-md-12.col-sm-12.col-xs-12
              div.text-center
                span.h4.coupon-title-start
                  | Free Coupons & Deals 
                span.h6
                  |  are available for you! Just 
                span.strong
                  | Click, 
                span.strong
                  | Save 
                span
                  | and 
                span.strong
                  | Email. 
      each coupon, i in coupons
        div.col-md-3.all.well(class=coupon.bizid.subcategory)
          div.row.deal-main.deal-coup.coupon-items.row-eq-height.coupon(id=coupon.id,class=(coupon.users.some(function(x) { return x.user_id == user.id })) ? 'couponclicked' : 'couponadd', rel=user.id)
            div 
              .div.col-md-12.col-sm-12.col-xs-12
                strong
                  h3                  
                  = coupon.name
              .div.col-md-12.col-lg-12.col-sm-12.col-xs-12
                  img.coup-img-wrapper.img-fluid(src="/uploads/thumbs/coupons/"+ coupon.photo, alt=coupon.bizid.name)
              .div.col-md-12.col-lg-12.col-sm-12.col-xs-12.float-left 
                h6
                  small
                    strong
                      | @       
                      =coupon.bizid.name
              
              .div.col-md-12.col-lg-12.col-sm-12.col-xs-12.float-left
                  =coupon.description
                
              .div.col-md-12.col-lg-12.col-sm-12.col-xs-12.center-left
                button.btn.btn-outline-primary(type="button" )
                  =coupon.tagline 
              .div.col-md-6.col-sm-12.col-xs-12.clipped.float-center
                button.btn.btn.danger
                  | Clipped  
                
                
  script(src='/javascripts/bootstrapjs/filter-gallery.js')          
  //Script for selecting coupons       
  script(type='text/javascript').
    //(function($) {
    $(function(){
          //script for sticky coupons on scroll
      $("#coupons-sticky").stick_in_parent();
      $(".clipped").hide();
      var cartCount = #{mycoupons.length};
      $(document).on('click', '.couponadd', function(event) {
        //alert("clicked");
        var couponid = $(this).attr("id");
        $(this).addClass('couponclicked');
        $(this).removeClass('couponadd');
        $(this).find('.clipped').show();
        $(this).find('.fa-status').html('<i class="fa fa-window-close fa-2x" aria-hidden="true" style="display:block;text-align:right"></i>');
        $.ajax({
            type: "GET",
            url: "/getcoupon/user/"+couponid,
            success: function(data){
                if(#{loggedin} == false){
                  //alert("not logged in");
                  window.location.href = "/login";
                  throw new Error("kindly login!");
                }
                Notify.toast(data.msg, {
                  fn: function () {
                    // custom function here
                  }
                });
                if(data.msg == 'Coupon Obtained'){
                  cartCount = cartCount + 1;
                  if(cartCount >= 0){
                    $('#couponscount').text(cartCount);
                  }
                }
                $.ajax({
                    type: "GET",
                    url: "/api/mycoupons/",
                    success: function(data){
                      var carray = data.mycoupons; 
                      $('.mycoupons').html('');
                      carray.forEach(function(el) {
                        $('.mycoupons').append(
                          '<div class="coupon coupon-modal"><strong>'+el.name+'</strong>\
                          <i id=#{user.id} class="fa fa-close fa-fw text-right  del-coupon" rel='+el._id+' aria-hidden="true"></i></div>'
                        );
                      }); 
                      $('.mycoupons').append( '<br><strong><span class="coup-msg">Click "Mail All" then, check your email to get coupon codes<span></strong>');             
                      console.log(data.code);
                    }
                });
            }
        });                    
      });
      $(document).on('click', ".couponclicked", function(event) {
        $(this).removeClass('couponclicked');
        $(this).addClass('couponadd');
        $(this).find('.clipped').hide();
        var userid = $(this).attr("rel");
        $.ajax({
            type: "GET",
            url: "/removecoupon/"+ userid,
            success: function(data){
                Notify.toast(data.msg, {
                  fn: function () {
                    // custom function here
                  }
                });
                if(data.msg == 'Coupon Removed'){
                  cartCount = cartCount - 1;
                  if(cartCount >= 0){
                    $('#couponscount').text(cartCount);
                  }
                }
                $.ajax({
                    type: "GET",
                    url: "/api/mycoupons/",
                    success: function(data){
                      $('.mycoupons').html('');
                      data.mycoupons.forEach(function(el) {
                        $('.mycoupons').append(
                          '<div class="coupon"><strong>'+el.name+'</strong>\
                          <i id=#{user.id} class="fa fa-close fa-fw  del-coupon" rel='+el._id+' aria-hidden="true"></i></div>'
                        );
                      });
                      $('.mycoupons').append('<br><strong><span class="coup-msg">Click "Mail All" then, check your email to get coupon codes<span></strong>');
                    }
                });
            }
        });


        $(this).find('.fa-status').html('<i class="fa fa-plus-square fa-2x" aria-hidden="true" style="display:block;text-align:right"></i>');
      });

      $(document).on('click', ".del-coupon", function(event) {
        //alert($(this).attr("rel"));
        $('#'+$(this).attr("rel")).removeClass('couponclicked');
        $('#'+$(this).attr("rel")).addClass('couponadd');
        $.ajax({
          type: "GET",
          url: "/removecoupon/"+$(this).attr("id"),
          success: function(data){
            $.ajax({
              type: "GET",
              url: "/api/mycoupons/",
              success: function(data){
                $('.mycoupons').html('');
                data.mycoupons.forEach(function(el) {
                  $('.mycoupons').append(
                    '<div class="coupon"><strong>'+el.name+'</strong>\
                    <i id=#{user.id} class="fa fa-close fa-fw  del-coupon" rel='+el._id+' aria-hidden="true"></i></div>'
                  );
                });
                $('.mycoupons').append('<br><strong><span class="coup-msg">Click "Mail All" then, check your email to get coupon codes<span></strong>');
              }
          });
          }
        });
      });
    });
  
  //script to hide main menu on coupons page
  script(type='text/javascript').
    $(window).scroll(function() {

      if ($(this).scrollTop()>10)
      {
          $(function() {
            $("#homenavbar").hide();
            $("#searchCoup").show();
            
            
          });
          
      }
      else
      {
        $(function() {
            $("#homenavbar").show();
            $("#searchCoup").hide();
           
          });
        
      }
    });

    //hide coupons button on coupons page 
    window.onload = function() {
      document.getElementById('coupbtn').className = 'hide-coupbtn';
    };
    
    
  //end of hide coupons buttons on coupons page

  //script for opening modal
  script(type='text/javascript').
    // Get the modal
    var modal = document.getElementById('myModal');

    // Get the button that opens the modal
    var btn = document.getElementById("myBtn");

    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[0];

    // When the user clicks the button, open the modal 
    btn.onclick = function() {
        modal.style.display = "block";
    }

    // When the user clicks on <span> (x), close the modal
    span.onclick = function() {
        modal.style.display = "none";
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
  //script for filteing coupons based on category
  script(type='text/javascript').
    filterSelection("all")
    function filterSelection(c) {
      var x, i;
      x = document.getElementsByClassName("filterDiv");
      if (c == "all") c = "";
      for (i = 0; i < x.length; i++) {
        w3RemoveClass(x[i], "show");
        if (x[i].className.indexOf(c) > -1) w3AddClass(x[i], "show");
      }
    }

    function w3AddClass(element, name) {
      var i, arr1, arr2;
      arr1 = element.className.split(" ");
      arr2 = name.split(" ");
      for (i = 0; i < arr2.length; i++) {
        if (arr1.indexOf(arr2[i]) == -1) {element.className += " " + arr2[i];}
      }
    }

    function w3RemoveClass(element, name) {
      var i, arr1, arr2;
      arr1 = element.className.split(" ");
      arr2 = name.split(" ");
      for (i = 0; i < arr2.length; i++) {
        while (arr1.indexOf(arr2[i]) > -1) {
          arr1.splice(arr1.indexOf(arr2[i]), 1);     
        }
      }
      element.className = arr1.join(" ");
    }

    // Add active class to the current button (highlight it)
    var btnContainer = document.getElementById("myBtnContainer");
    var btns = btnContainer.getElementsByClassName("btn");
    for (var i = 0; i < btns.length; i++) {
      btns[i].addEventListener("click", function(){
        var current = document.getElementsByClassName("active");
        current[0].className = current[0].className.replace(" active", "");
        this.className += " active";
      });
    }
        
